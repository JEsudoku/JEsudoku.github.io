<style>
    #sudoku {
        --cellsize: 10vh;
        --border: 14px;
        --sudokuwidth: calc(calc(3 * var(--cellsize)) + var(--border));
        display: grid;
        grid: repeat(3, var(--sudokuwidth)) / repeat(3, var(--sudokuwidth));
        background: black;
        gap: 4px;
        box-sizing: border-box;
    }

    sudoku-block {
        display: grid;
        grid: repeat(3, 1fr) / repeat(3, 1fr);
        background: green;
        gap: 2px;
        max-width: calc(var(--sudokuwidth) + 3px);
        box-sizing: border-box;
        --border: 5px;
        border: var(--border) solid red;
    }

    sudoku-cell {
        grid: repeat(3, 1fr) / repeat(3, 1fr);
        width: var(--cellsize);
        height: var(--cellsize);
        display: inline-block;
        background: beige;
        text-align: center;
        font-size: 5rem;
        justify-content: center;
        z-index: 2;

    }

    sudoku-choice {
        visibility: hidden;
        width: 3.1vh;
        height: 3.1vh;
        display: none;
        background: beige;
        text-align: center;
        border: 1px solid black;
        font-size: 0.3em
    }

    sudoku-answer {
        z-index: -1;
    }

    .visible {
        visibility: visible;
        display: inline-block;
    }

    .wrong {
        background-color: red;
    }
</style>
<div id="sudoku">
    <sudoku-block></sudoku-block>
    <sudoku-block></sudoku-block>
    <sudoku-block></sudoku-block>
    <sudoku-block></sudoku-block>
    <sudoku-block></sudoku-block>
    <sudoku-block></sudoku-block>
    <sudoku-block></sudoku-block>
    <sudoku-block></sudoku-block>
    <sudoku-block></sudoku-block>
</div>
<script>

    HTMLElement.prototype.textNodes = function () {
        return [...this.childNodes].filter((node) => {
            return (node.nodeType === Node.TEXT_NODE && node.nodeValue.trim() !== "");
        });
    }
    customElements.define("sudoku-block", class extends HTMLElement {
        connectedCallback() {
            let blocknr = [...this.parentNode.children].indexOf(this);
            console.log("block:", blocknr);
            this.setAttribute("block", blocknr);
            this.innerHTML = Array(9).fill(0).map((value, index) => {
                return `<sudoku-cell index="${index}">${index}</sudoku-cell>`
            }).join("")
        }
    });
    customElements.define("sudoku-cell", class extends HTMLElement {
        connectedCallback() {
            this.onclick = () => {
                console.log("cell:", this);
                console.log("block:", this.parentNode);
            }
            this.innerHTML = Array(9).fill(0).map((value, index) => {
                return `<sudoku-choice index="${index}">${index + 1}</sudoku-choice>`
            }).join("")
        }
        get value() {
            return this.querySelector('sudoku-answer') ? this.querySelector('sudoku-answer').innerHTML : null
        }
    });

    document.addEventListener("click", (event) => {
        const target = event.target;
        console.log(target);
        console.log(target.textContent.length);
        if (target.hasChildNodes && !target.classList.contains('visible')) {
            if (target.textContent.length > 9) {
                target.firstElementChild.textContent = ''
            }
            target.classList.remove("wrong")
            let oldAnswer = target.querySelector('sudoku-answer');
            console.log(oldAnswer);
            if (typeof oldAnswer !== "undefined" && oldAnswer !== null) {
                oldAnswer.remove();
            }
            let targetCells = Array.from(target.children);
            console.log(targetCells);
            targetCells.forEach((element) => {
                element.classList.add("visible")
            })

        }

        else if (target.classList.contains('visible')) {
            let sudokuPickedCell = target.parentNode;
            console.log(sudokuPickedCell);
            let targetValue = target.textContent;
            let TargetElement = document.createElement('sudoku-answer');
            TargetElement.innerHTML = targetValue;
            sudokuPickedCell.insertAdjacentElement('afterBegin', TargetElement);
            let originalChoiceGridArray = Array.from(sudokuPickedCell.children);
            originalChoiceGridArray.forEach((element) => {
                element.classList.remove("visible")
            })
            checkErrorRows();
            checkErrorColumns();
            checkErrorBlocks();
        }

        else {
            console.log("not a valid cell")
        }
    })

    function checkErrorRows() {
        for (let rownr = 1; rownr < 10; rownr++) {
            let checkRowArray = Array.from(document.querySelectorAll(`[row="${rownr}"]`));
            let checkRowContent = checkRowArray.map((cell, idx) => cell.value);
            console.log(checkRowContent)
            let duplicates = checkDuplicates(checkRowContent);
            console.log(duplicates);
            checkRowArray.forEach((element) => {
                console.log("checked")
                console.log(element)
                let elementAnswer = element.value
                console.log(elementAnswer);
                if (duplicates.length !== 0 && elementAnswer !== null) {
                    if (duplicates.includes(elementAnswer)) {
                        console.log(elementAnswer, duplicates)
                        element.classList.add("wrong")
                        console.log("wrong")
                    }
                    else (console.log("correct"))

                }
            })
        }
    }

    function checkErrorColumns() {
        for (let colnr = 1; colnr < 10; colnr++) {
            let checkColArray = Array.from(document.querySelectorAll(`[col="${colnr}"]`));
            let checkColContent = checkColArray.map((cell, idx) => cell.value);
            let duplicates = checkDuplicates(checkColContent);
            checkColArray.forEach((element) => {
                let elementAnswer = element.value
                if (duplicates.length !== 0 && elementAnswer !== null) {
                    if (duplicates.includes(elementAnswer)) {
                        element.classList.add("wrong")
                    }
                    else (console.log("correct"))
                }
            })
        }
    }

    // todo check why it doesnt work
    // function checkErrorBlocks() {
    //     for (let blocknr = 1; blocknr < 10; blocknr++) {
    //         let checkBlockArray = Array.from(document.querySelectorAll(`[block="${blocknr}"]`));
    //         let checkBlockContent = checkBlockArray.map((cell, idx) => cell.value);
    //         let duplicates = checkDuplicates(checkBlockContent);
    //         checkBlockArray.forEach((element) => {
    //             let elementAnswer = element.value
    //             if (duplicates.length !== 0 && elementAnswer !== null) {
    //                 if (duplicates.includes(elementAnswer)) {
    //                     element.classList.add("wrong")
    //                 }
    //                 else (console.log("correct"))
    //             }
    //         })
    //     }
    // }

    function checkDuplicates(inputArray) {
        const arraylength = inputArray.length;
        // console.log("duplicatecheck activated", arraylength, inputArray)
        const verwerktArray = [];
        const duplicateArray = [];
        for (let i = 0; i < arraylength; i++) {
            if (inputArray[i]) {
                let answer = inputArray[i]
                if (verwerktArray.includes(answer) === true) {
                    duplicateArray.push(answer);
                } else {
                    verwerktArray.push(answer);
                }
            }
            // console.warn(inputArray[i], duplicateArray, verwerktArray);

        }
        return duplicateArray
    }


    let nodelistcells = document.querySelectorAll("sudoku-cell");
    console.log(nodelistcells);
    let AllCells = Array.from(document.querySelectorAll("sudoku-cell"));
    console.log(AllCells);

    function Row() {
        AllCells.forEach((element) => {
            let isTopRowBlock = "0 1 2".includes(element.parentNode.getAttribute("block"));
            let isMiddleRowBlock = "3 4 5".includes(element.parentNode.getAttribute("block"));
            let isBottomRowBlock = "6 7 8".includes(element.parentNode.getAttribute("block"));
            let index = element.getAttribute("index")
            let isTopRow = index == "0" || index == "1" || index == "2"
            let isMiddleRow = index == "3" || index == "4" || index == "5"
            let isBottomRow = index == "6" || index == "7" || index == "8"
            if (isTopRowBlock && isTopRow) {
                element.setAttribute("row", 1);
            } else if (isTopRowBlock && isMiddleRow) {
                element.setAttribute("row", 2);
            } else if (isTopRowBlock && isBottomRow) {
                element.setAttribute("row", 3)
            }
            if (isMiddleRowBlock && isTopRow) {
                element.setAttribute("row", 4);
            } else if (isMiddleRowBlock && isMiddleRow) {
                element.setAttribute("row", 5);
            } else if (isMiddleRowBlock && isBottomRow) {
                element.setAttribute("row", 6)
            }
            if (isBottomRowBlock && isTopRow) {
                element.setAttribute("row", 7);
            } else if (isBottomRowBlock && isMiddleRow) {
                element.setAttribute("row", 8);
            } else if (isBottomRowBlock && isBottomRow) {
                element.setAttribute("row", 9)
            }
        })
    };

    function Col() {
        AllCells.forEach((element) => {
            let isLeftColBlock = "0 3 6".includes(element.parentNode.getAttribute("block"));
            let isMiddleColBlock = "1 4 7".includes(element.parentNode.getAttribute("block"));
            let isRightColBlock = "2 5 8".includes(element.parentNode.getAttribute("block"));
            let index = element.getAttribute("index");
            let isLeftCol = index == "0" || index == "3" || index == "6"
            let isMiddleCol = index == "1" || index == "4" || index == "7"
            let isRightCol = index == "2" || index == "5" || index == "8"
            if (isLeftColBlock && isLeftCol) {
                element.setAttribute("col", 1)
            } else if (isLeftColBlock && isMiddleCol) {
                element.setAttribute("col", 2)
            } else if (isLeftColBlock && isRightCol) {
                element.setAttribute("col", 3)
            } else if (isMiddleColBlock && isLeftCol) {
                element.setAttribute("col", 4)
            } else if (isMiddleColBlock && isMiddleCol) {
                element.setAttribute("col", 5)
            } else if (isMiddleColBlock && isRightCol) {
                element.setAttribute("col", 6)
            } else if (isRightColBlock && isLeftCol) {
                element.setAttribute("col", 7)
            } else if (isRightColBlock && isMiddleCol) {
                element.setAttribute("col", 8)
            } else if (isRightColBlock && isRightCol) {
                element.setAttribute("col", 9)
            }
        })
    }

    Row();
    Col();
</script>